name: Run Ollama with GitHub Actions

on:
  push:
    branches:
      - main  # 指定触发此工作流的分支


jobs:
  run-ollama:
    runs-on: ubuntu-latest

    steps:
    # - name: Checkout repository
    #   uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh

    - name: Start Ollama Service
      run: |
        nohup ollama serve &  # 使用nohup确保服务在后台持续运行
        sleep 10  # 等待服务启动完成

    - name: Download Qwen Model
      run: |
        # ollama run qwen2.5:1.5b
        ollama run qwen2.5:0.5b
        
    - name: Make Non-Streaming Request
      run: |
        URL="http://localhost:11434/api/generate"
        DATA='{
          "model": "qwen2.5:0.5b",
          "stream": false,
          "prompt": "你是谁。"
        }'
        RESPONSE=$(curl -s -X POST $URL -H "Content-Type: application/json" -d "$DATA")
        # echo "Response: $RESPONSE"
        # 解析并打印返回的消息
        MESSAGE=$(echo $RESPONSE | jq -r '.response')
        echo "Message: $MESSAGE"
